name: Release

on:
    push:
        tags:
            - "v*"

permissions:
    contents: write

jobs:
    build-and-publish:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Setup Go
              uses: actions/setup-go@v4
              with:
                  go-version: "1.21"

                        - name: Install native build dependencies
                            run: |
                                sudo apt-get update
                                sudo apt-get install -y --no-install-recommends \
                                    build-essential pkg-config git ca-certificates curl \
                                    libgtk-3-dev libgl1-mesa-dev libglu1-mesa-dev \
                                    libx11-dev libxrandr-dev libxcursor-dev libxinerama-dev \
                                    libxss-dev libxtst-dev libasound2-dev libcairo2-dev \
                                    libpango1.0-dev libgdk-pixbuf2.0-dev
                            shell: bash

                        - name: Build release artifacts
                            env:
                                CGO_ENABLED: '1'
                            run: |
                                    chmod +x scripts/build_release.sh
                                    ./scripts/build_release.sh

            - name: Authenticate gh CLI
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  if ! command -v gh >/dev/null 2>&1; then
                    sudo apt-get update && sudo apt-get install -y gh
                  fi
                  echo "$GITHUB_TOKEN" | gh auth login --with-token

            - name: Create GitHub release and upload assets
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  TAG=${{ github.ref_name }}
                  gh release create "$TAG" dist/* --title "$TAG" --notes "Release $TAG"
